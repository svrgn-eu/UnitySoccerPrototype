using NET.efilnukefesin.Unity.Attributes;
using System;
using System.Collections;
using System.Collections.Generic;
using System.Reflection;
using UnityEditor;
using UnityEngine;

[CustomPropertyDrawer(typeof(PropertyGetSetAttribute))]
public sealed class PropertyGetSetDrawer : PropertyDrawer
{
    #region Methods

    #region OnGUI
    public override void OnGUI(Rect position, SerializedProperty property, GUIContent label)
    {
        PropertyGetSetAttribute attribute = (PropertyGetSetAttribute)base.attribute;

        EditorGUI.BeginChangeCheck();
        EditorGUI.PropertyField(position, property, label);

        if (EditorGUI.EndChangeCheck())
        {
            attribute.dirty = true;
        }
        else if (attribute.dirty)
        {
            object parent = PropertyGetSetDrawer.GetParentObject(property.propertyPath, property.serializedObject.targetObject);

            Type type = parent.GetType();
            PropertyInfo info = type.GetProperty(attribute.name);

            if (info == null)
            {
                Debug.LogError("Invalid property name \"" + attribute.name + "\"");
            }
            else
            {
                info.SetValue(parent, fieldInfo.GetValue(parent), null);
            }
            attribute.dirty = false;
        }
    }
    #endregion OnGUI

    #region GetParentObject
    public static object GetParentObject(string path, object obj)
    {
        string[] fields = path.Split('.');

        if (fields.Length == 1)
        {
            return obj;
        }

        FieldInfo info = obj.GetType().GetField(fields[0], BindingFlags.Public | BindingFlags.NonPublic | BindingFlags.Instance);
        obj = info.GetValue(obj);

        return GetParentObject(string.Join(".", fields, 1, fields.Length - 1), obj);
    }
    #endregion GetParentObject

    #endregion Methods
}